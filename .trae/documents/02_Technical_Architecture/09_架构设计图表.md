# Jackery Atlas 架构设计（前后分离：前端 Monorepo + 后端 Java + Node）

## 演示精选（30分钟建议顺序）
1. 系统整体分层架构图（讲“谁对公网、谁内网、数据流”）
2. 构建与发布管线时序图（讲“jobId 异步 + 版本化产物 + 原子切换 + 回滚”）
3. 权限与审计/发布治理相关图（讲“单入口治理、可追溯”）
4. Schema/内容模型相关图（讲“Schema First + Shopify Compatible”）
5. 全局组件批量发布相关图（答疑用：Header/Footer/Cookie Banner）

## 系统整体分层架构图

```mermaid
graph TB
  subgraph "用户层"
    U1[访客/消费者]
    U2[运营/内容编辑]
    U3[管理员/开发者]
  end

  subgraph "接入层"
    C1["静态站点 Runtime\nStatic HTML JS"]
    C2["Builder Editor"]
    C3[Admin]
  end

  subgraph "应用层"
    S1[Preview]
    S2[Publisher]
    S3[Commerce]
    S4[Adapter]
    S5[Auth]
  end

  subgraph "能力层"
    B1[页面建模与 Schema]
    B2[渲染与构建]
    B3[发布与 CDN]
    B4[i18n 配置中心]
    B5["交易闭环\nCart Checkout Order"]
  end

  subgraph "技术与数据层"
    DB[(Postgres JSONB)]
    Cache[(Redis)]
    Bus[(Queue Event)]
    Obj[对象存储 S3]
    CDN[CDN CloudFront]
    Shopify[Shopify API]
    Webhook[Shopify Webhooks]
    Java["Java Backend\nAPI Auth Commerce"]
    NodePreview["Node\nPreview Renderer"]
    NodeWorker["Node\nPublisher Worker"]
    IDP[Keycloak]
  end

  subgraph "基础设施与治理"
    Run[ECS Fargate]
    Obs["监控日志\nCloudWatch OTel Prometheus"]
    Sec["权限与密钥\nIAM SSM"]
  end

  U1 --> C1
  U2 --> C2
  U3 --> C3

  C2 -->|MVP REST| Java
  C3 -->|MVP REST| Java
  Java --> DB
  Java --> Cache
  Java --> Bus
  Java --> Shopify
  Java --> IDP
  Webhook -->|订单事件| Java

  Java -->|预览| NodePreview
  Java -->|发布| NodeWorker
  NodePreview --> DB
  NodeWorker --> DB
  NodeWorker --> Obj

  Obj --> CDN

  Run --- Java
  Run --- S1
  Run --- S2
  Run --- NodePreview
  Run --- NodeWorker
  Obs --- Run
  Sec --- Run
```

## 组件图（逻辑模块与边界）

```mermaid
graph LR
  User[User Browser]

  subgraph "Frontend Monorepo"
    Builder["Builder Editor"]
    Admin[Admin]
    Runtime[Static Site Runtime]
  end

  subgraph "Backend Java"
    Java["Java Backend\nAPI Auth Commerce"]
  end

  subgraph "Backend Node"
    Preview["Preview\nRenderer"]
    Worker["Publisher\nWorker"]
  end

  subgraph "External Services"
    Shopify[Shopify API]
    S3[S3]
    CDN[CloudFront]
    Webhook[Shopify Webhooks]
  end

  User --> Runtime
  User --> Builder
  User --> Admin

  Builder -->|REST| Java
  Admin -->|REST| Java
  Java --> Shopify
  Webhook --> Java

  Java -->|preview| Preview
  Preview --> DB[(Postgres)]

  Java -->|publish| Worker
  Worker --> DB
  Worker --> S3
  S3 --> CDN
  CDN --> Runtime
```

## 前后端分离图（分离点与连接点）

```mermaid
graph LR
  subgraph "前端 浏览器侧"
    FE1[Static Site Runtime]
    FE2["Builder Editor"]
    FE3[Admin]
  end

  subgraph "后端 服务侧"
    Java["Java Backend\nAPI Auth Commerce"]
    Preview["Node Preview\nRenderer"]
    Worker["Node Publisher\nWorker"]
    DB[(Postgres)]
    S3[S3]
  end

  subgraph "外部系统"
    Shopify[Shopify API]
    Webhook[Shopify Webhooks]
    CDN[CloudFront]
  end

  FE1 -->|静态资源分发| CDN
  CDN --> S3

  FE2 -->|REST| Java
  FE3 -->|REST| Java
  Java --> Shopify
  Webhook -->|订单事件| Java

  Java -->|预览| Preview
  Preview --> DB

  Java -->|发布| Worker
  Worker --> DB
  Worker --> S3
```

## 用例图（核心用例）

```mermaid
graph LR
  Visitor[访客/消费者]
  Operator[运营/内容编辑]
  AdminUser[管理员]
  BuildSystem[构建系统]
  Shopify[Shopify]

  UC1[访问静态站点]
  UC2[编辑页面与组件配置]
  UC3[保存草稿]
  UC4[预览页面]
  UC5[发布站点]
  UC6[管理多语言文案]
  UC7[加购与购物车]
  UC8[结算跳转 Checkout]
  UC9[订单回写与查询]

  Visitor --> UC1
  Visitor --> UC7
  Visitor --> UC8
  Visitor --> UC9

  Operator --> UC2
  Operator --> UC3
  Operator --> UC4
  Operator --> UC5
  Operator --> UC6

  AdminUser --> UC5
  AdminUser --> UC6
  AdminUser --> UC9

  BuildSystem --> UC5
  Shopify --> UC7
  Shopify --> UC8
  Shopify --> UC9
```

## 时序图

### 编辑保存（MVP: Java API + DB）

```mermaid
sequenceDiagram
  participant U as 运营/编辑
  participant B as Builder/Editor
  participant API as Java Backend
  participant DB as Postgres DB

  U->>B: 修改页面/Section/Block 配置
  B->>API: 保存页面
  alt 通过
    API->>DB: 写入 JSONB
    DB-->>API: OK
    API-->>B: OK
    B-->>U: 保存成功
  else 拒绝
    API-->>B: Deny
    B-->>U: 无权限
  end
```

### 预览（MVP: Java API + Node Preview）

```mermaid
sequenceDiagram
  participant U as 运营/编辑
  participant B as Builder/Editor
  participant API as Java Backend
  participant PV as Node Preview
  participant DB as Postgres DB
  participant R as Renderer

  U->>B: 点击预览
  B->>API: 请求预览
  API->>PV: 预览渲染
  PV->>DB: 读取页面 JSON
  DB-->>PV: PageInstance
  PV->>R: JSON -> HTML
  R-->>PV: HTML/Assets
  PV-->>API: 预览结果
  API-->>B: 预览结果
  B-->>U: 展示预览
```

### 发布（Java 触发 -> Node Worker -> S3 -> CDN）

```mermaid
sequenceDiagram
  participant O as 运营/管理员
  participant B as Builder/Admin
  participant API as Java Backend
  participant W as Node Worker
  participant DB as Postgres DB
  participant R as Renderer
  participant S3 as S3
  participant CDN as CloudFront

  O->>B: 点击发布
  B->>API: 创建发布任务
  API-->>W: 触发构建任务
  W->>DB: 读取页面/配置/i18n
  DB-->>W: JSON 数据
  W->>R: 渲染构建
  R-->>W: 静态产物
  W->>S3: 上传产物
  S3-->>W: OK
  W->>CDN: Invalidate/更新版本
  CDN-->>W: OK
  W-->>API: 构建完成
  API-->>B: 构建完成
```

### 交易闭环（Cart/Checkout + Webhook 回写）

```mermaid
sequenceDiagram
  participant U as 访客/消费者
  participant RT as Runtime Static Site
  participant API as Java Backend
  participant Shopify as Shopify API
  participant WH as Shopify Webhooks
  participant DB as Postgres DB

  U->>RT: 加购/更新购物车
  RT->>API: cart
  API->>Shopify: Storefront Cart
  Shopify-->>API: cart
  API-->>RT: 返回购物车状态

  U->>RT: 去结算
  RT->>API: checkout
  API->>Shopify: 获取 checkout URL
  Shopify-->>API: webUrl
  API-->>RT: webUrl
  RT-->>U: 跳转 Shopify Checkout

  Shopify-->>WH: 订单创建/支付事件
  WH-->>API: order webhook
  API->>DB: 持久化订单摘要
  DB-->>API: OK
```

## 类图（核心数据与Schema）

```mermaid
classDiagram
  class PageInstance {
    +string name
    +string wrapper
    +object sections
    +list order
  }

  class SectionInstance {
    +string type
    +boolean disabled
    +object settings
    +object blocks
    +list block_order
    +string _id
    +string _label
  }

  class BlockInstance {
    +string type
    +object settings
    +string _id
  }

  PageInstance "1" --> "many" SectionInstance : sections
  SectionInstance "0..1" --> "many" BlockInstance : blocks

  class ComponentDefinition {
    +string type
    +string name
    +string class
    +string tag
    +number limit
    +list settings
    +list blocks
    +list presets
    +string icon
    +string category
  }

  class BlockDefinition {
    +string type
    +string name
    +number limit
    +list settings
  }

  class PresetDefinition {
    +string name
    +object settings
    +list blocks
  }

  class PresetBlock {
    +string type
    +object settings
  }

  class SettingDefinition {
    +string type
    +string id
    +string label
    +any default
    +string info
    +string placeholder
    +list options
    +number min
    +number max
    +number step
    +string unit
    +list accept
  }

  class Option {
    +string label
    +string value
  }

  SectionInstance --> ComponentDefinition : type
  BlockInstance --> BlockDefinition : type
  ComponentDefinition --> SettingDefinition
  BlockDefinition --> SettingDefinition
  SettingDefinition --> Option

  class TranslationDefinition {
    +string id
    +string label
    +string type
    +string description
    +any default
    +list variables
  }

  class TranslationGroup {
    +string id
    +string name
    +list items
  }

  class SiteLocaleConfig {
    +string default_locale
    +list published_locales
    +object translations
  }

  class LocaleDictionary {
    +any data
  }
```

## 状态图

### 页面生命周期（草稿/发布/归档）

```mermaid
stateDiagram
  [*] --> Draft
  Draft --> Published: publish
  Published --> Draft: unpublish
  Published --> Archived: archive
  Archived --> Draft: restore
  Draft --> Archived: archive
  Archived --> [*]
```

### 构建与发布状态（队列/构建/部署）

```mermaid
stateDiagram
  [*] --> Idle
  Idle --> Queued: trigger-build
  Queued --> Building: start
  Building --> Deployed: success
  Building --> Failed: error
  Failed --> Queued: retry
  Deployed --> Idle: idle
  Failed --> Idle: cancel
```

## 活动图（发布流水线）

```mermaid
graph TD
  A[触发发布]
  B[读取页面/配置/i18n]
  C[渲染构建 JSON to HTML Assets]
  D[上传产物到 S3]
  E[CloudFront Invalidate 或版本切换]
  F[发布完成]
  X[失败]
  R[重试/回滚/告警]

  A --> B --> C --> D --> E --> F
  B -->|读取失败| X
  C -->|渲染失败| X
  D -->|上传失败| X
  E -->|失效失败| X
  X --> R --> A
```

## 部署图

### MVP（Java Backend + Node Preview Worker + S3 CloudFront）

```mermaid
graph TB
  subgraph "Client"
    Browser[Browser]
  end

  subgraph "Static Delivery"
    CF[CloudFront]
    S3[S3]
  end

  subgraph "Service"
    Java["Java Backend\nAPI Auth Commerce"]
    Preview["Node Preview\nRenderer"]
    Worker["Node Publisher\nWorker"]
  end

  subgraph "Data"
    DB[(Postgres)]
  end

  subgraph "External"
    Shopify[Shopify API]
    Webhook[Shopify Webhooks]
  end

  Browser --> CF
  CF --> S3

  Browser --> Java
  Webhook --> Java
  Java --> DB
  Java --> Shopify

  Java --> Preview
  Preview --> DB

  Java --> Worker
  Worker --> DB
  Worker --> S3
```

### Scale（Java + Node + Queue Cache）

```mermaid
graph TB
  subgraph "Client"
    Browser[Browser]
  end

  subgraph "Static Delivery"
    CF[CloudFront]
    S3[S3]
  end

  subgraph "AWS VPC"
    subgraph "ECS Fargate"
      Java["Java Backend\nAPI Auth Commerce"]
      Preview["Node Preview\nRenderer"]
      Worker["Node Publisher\nWorker"]
    end

    RDS[(Postgres)]
    Redis[(Redis)]
    Bus[(Queue Event)]
    IDP[Keycloak]
  end

  subgraph "External"
    Shopify[Shopify API]
    Webhook[Shopify Webhooks]
  end

  Browser --> CF
  CF --> S3

  Browser --> Java
  Java --> RDS
  Java --> Redis
  Java --> Bus
  Java --> IDP
  Java --> Shopify

  Preview --> RDS
  Worker --> RDS
  Worker --> S3

  Webhook --> Java
```

## 逻辑架构
- 前端：Builder/Editor + Admin + Site Runtime（Monorepo，复用 schema 与渲染）
- 后端：Java 模块化单体（可演进微服务）
  - atlas-api（REST + OpenAPI）
  - atlas-builder（编辑协调，预览与发布触发）
  - atlas-commerce（购物车/结算/订单 Webhook）
  - atlas-adapter-shopify（Shopify 适配）
  - atlas-auth（OIDC 集成）
  - atlas-storage（数据库/对象存储抽象）
- 渲染层：Node TypeScript 渲染库，预览与构建复用

## 数据架构
- PostgreSQL（JSONB 存储 Page/Section/Block）
- Redis（缓存，可选）；Queue Event（可选，用于构建触发与异步编排）
- S3（页面产物/媒体）；CloudWatch/Prometheus（日志与指标）

## 部署架构（AWS）
- S3 + CloudFront：静态站点 CDN 分发
- ECS Fargate：Java Backend（对外唯一入口）
- ECS Fargate：Node Preview（常驻）与 Node Worker（弹性）
- Route53/ACM：域名与证书；VPC/IAM/SSM：网络与权限与参数管理

## 运行时约束

* 纯静态发布，前台无 Node Runtime

* 构建并行与失败重试；版本化与精确 Invalidation

* 安全：OIDC（Keycloak）+ RBAC；最小权限 IAM；密钥与参数集中管理

## 与 Shopify 的边界

* 编辑态：实时拉取（限额与退避）；构建态：必要数据 build-time 注入

* 交易与订单由 Shopify 完成；本系统通过 Storefront API/Checkout 跳转与订单 Webhook 实现闭环（查看/购买/Checkout/订单）

## 购物流程（闭环）

1. 产品查看：静态页展示产品信息（来自 Shopify Storefront API）
2. 加入购物车：调用 Commerce API（后端代理 Storefront Cart）
3. 查看购物车：读取 cartId，展示明细与总计/折扣
4. 结算：获取 checkout webUrl 并跳转至 Shopify Checkout 完成支付
5. 订单：后端接收订单 Webhook，持久化摘要；用户可在“订单”页面查询（可选需登录）

## 模块清单与职责

* atlas-api

  * 职责：统一 REST 路由、OpenAPI 文档、认证与鉴权入口、错误处理

  * 部署：Java 应用，随主应用容器部署，水平扩展

* atlas-builder

  * 职责：编辑/预览协调；草稿保存；预览渲染触发与结果回传

  * 部署：随主应用容器部署；预览为常驻服务，无冷启动

* atlas-publisher

  * 职责：构建与发布协调；SQS/Step Functions 编排；产物上传 S3；CloudFront Invalidation

  * 部署：随主应用提供 API；构建执行在独立 ECS Fargate 任务容器

* atlas-adapter-shopify

  * 职责：Shopify Storefront/Admin 客户端；限流与重试；数据缓存；Webhook 注册与校验

  * 部署：随主应用容器部署；与 Redis/SQS 集成

* atlas-commerce

  * 职责：购物车（Cart）、结算（Checkout webUrl）、订单 Webhook 处理与查询

  * 部署：随主应用容器部署；对接 Storefront GraphQL 与 Admin Webhook

* atlas-auth

  * 职责：OIDC/OAuth2 集成（Keycloak）；用户/角色/RBAC；令牌校验与续期

  * 部署：随主应用容器部署；依赖 Keycloak 实例

* atlas-storage

  * 职责：PostgreSQL JSONB 的 DAO 与仓储；Redis 缓存；S3 对象存储抽象；备份与版本管理

  * 部署：随主应用容器部署；对接 EC2 PostgreSQL、ElastiCache、S3

## 部署形态建议

* MVP：Java Backend（ECS）+ Node Preview（ECS 常驻）+ Node Worker（任务）+ Postgres + S3 CloudFront

* Scale：Java + Node + Redis + Queue Event（异步触发与编排）

* 观测：CloudWatch Prometheus OpenTelemetry

## 技术选型（MVP: Java + Node）

* Backend API: Java Backend（Spring Boot 生态）

* Renderer Preview Worker: Node TypeScript

* Database: Postgres JSONB

* Auth: OIDC（Keycloak 或企业 SSO）

## 预览实现选项

* 选项 A：Lambda + TypeScript CLI（低成本、按需、无服务器；适合短时预览）

* 选项 B：ECS Fargate 常驻的 TypeScript 预览服务（无冷启动，适合稳定高并发）

## 更多细节

* 参见后端总体设计文档：[08_后端总体设计.md](./08_后端总体设计.md)

## 迁移与扩展

* 主题迁移：Liquid AST → HTML/Settings → DSL/组件骨架

* 扩展点：Section/Block DSL；渲染器组件解析；发布管线插件化

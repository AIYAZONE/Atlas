# SLA 与发布体系（99.9 / 10000 页）

## 目标与边界
- 目标：内部系统可用性 99.9；页面规模 10000；发布可控、可回滚、可审计。
- 架构前提：前台纯静态（S3/CloudFront）；对外唯一入口为 Java；Node 仅用于 Preview/Publisher（内网）。

## SLA 口径
- 99.9：月度不可用时间预算约 43 分钟（30 天）。
- 建议按能力拆 SLO：
  - Java API（登录/鉴权/编辑/发布入口）：99.9
  - Node Preview（预览）：99.5–99.9（允许短时降级）
  - 发布/构建：以“成功率 + 可重试 + 可回滚”为主，不强求与在线 SLA 等同

## 10000 页规模的发布策略（必须增量）
- 默认增量发布：只构建变更页面 + 依赖页面（导航/全局区块/共享数据）。
- 全量构建仅用于：灾备重建、重大版本升级、数据迁移后的重发布。
- 构建产物按版本不可变：S3 以 version 前缀写入（或等价方式），便于回滚。
 - 可选优化：对 Header/Footer 这类高频小改动，可评估 CDN 边缘 HTML 重写方案以减少全站重建次数，但必须保留批量发布作为兜底与一致性校验。

## 发布任务模型（最小企业级）
### Job 表（建议字段）
- job_id（UUID）
- site_id
- trigger_by（user_id / service）
- trigger_reason（manual / schedule / webhook / migration）
- target_version（或 change_set_hash）
- theme_id / theme_version（MVP方案A：站点选择的主题版本）
- feature_versions（能力包版本集合，如 commerce/tracking/cookie-consent）
- content_version（内容版本/哈希）
- config_version（站点配置版本：导航/域名/地区策略等）
- status（Queued / Building / Deployed / Failed / Cancelled）
- created_at / started_at / finished_at
- progress（0-100，可选）
- retry_count
- error_code / error_message（摘要）

### 状态机
- Queued -> Building -> Deployed
- Queued -> Cancelled
- Building -> Failed -> Queued（retry）
- Deployed -> Queued（republish / rollback as new job）

### Java API 行为（强制异步）
- 发布接口只做：创建 job + 触发执行，立即返回 job_id。
- 不允许“同步等待构建完成”，避免长请求影响可用性与线程资源。

## 幂等、重试与回滚
### 幂等键（必须）
- Webhook：使用 shopify_event_id 或 payload_hash（带时间窗）防重放。
- 发布：按 (site_id, target_version) 或 (site_id, change_set_hash) 去重。

### 重试策略（建议默认）
- 仅对可恢复错误重试：网络抖动、对象存储偶发失败、429/5xx。
- 指数退避：base=500ms，factor=2，max=30s，max_attempts=6。

### 回滚策略（推荐）
- 版本化产物：version 目录不可变。
- 回滚目标：5 分钟内完成（通过版本切换或原子更新指针文件实现）。

## 并发与限流默认参数（可直接用）
### Worker 并发
- 单 Worker 进程 render_concurrency=4（CPU 够再升 8）
- 站点级 max_inflight_jobs=1–2（先保守，稳定后提升）

### Shopify 访问限流
- 全局 shopify_concurrency=2–5
- 429/5xx 走重试与退避，避免放大故障

### 发布去抖
- 同一站点/同一变更集合 30–60 秒内重复触发，合并为一个 job。

## 可观测与验收指标（建议写进验收）
### API（Java）
- P95 延迟 < 300ms（不含外部慢接口单列）
- 5xx < 0.1%

### 发布/构建
- 构建成功率 >= 99%
- 重试后成功率 >= 99.9%
- 单页增量发布完成时间 P95 < 2 分钟（按页面复杂度可调）
- 回滚生效时间 < 5 分钟

## 基础设施最小配置（支撑 99.9）
- Postgres：多 AZ 或等价高可用；定期备份；月度恢复演练；明确 RTO/RPO。
- Java API：至少 2 实例跨 AZ；健康检查与滚动发布。
- Node Preview：至少 2 实例跨 AZ（预览不影响前台，但影响运营效率）。
- Worker：任务弹性运行；失败可重跑；并发受控。

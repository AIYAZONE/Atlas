# 开发重难点清单 (Technical Challenges)

> **文档说明**：本文档梳理了 Jackery Atlas 项目在架构、编辑器和业务实现上的“硬骨头”，作为排期评估和技术攻坚的依据。

## A. 架构基建重难点 (Infrastructure)

### 1. Monorepo 依赖管理与类型共享
*   **难点**：`schema` 包 (TS 定义) 需要同时被 `builder` (Vue) 和 `renderer` (Nuxt) 引用。
*   **挑战**：避免版本冲突，确保 TypeScript 类型在修改 Schema 后能实时推导，无需频繁 Build。
*   **方案**：使用 PNPM Workspace + TypeScript Project References (`composite: true`)。

### 2. 后端鉴权与权限策略（Java RBAC + 最小 RLS）
*   **难点**：
    *   **编辑器**：需要读写权限 (Admin Role)。
    *   **预览/构建**：需要只读权限 (Service Role)。
    *   **C端用户**：不可直接访问 Page 表。
*   **挑战**：设计一套既安全又不影响开发体验的 Row Level Security 策略。

### 3. SSG 构建流水线 (Build Pipeline)
*   **难点**：当页面数量达到 1000+ 时，全量构建非常慢。
*   **挑战**：
    *   实现 **增量构建 (ISR)**：只重构变更的页面。
    *   **并发控制**：防止触发 Shopify API 429 限流。
    *   **错误容忍**：单个页面构建失败不应阻塞整体发布。

---

## B. 可视化编辑器重难点 (Visual Builder)

### 1. 跨 Frame 通信 (Cross-Frame Comms)
*   **难点**：Builder (父) 控制 Preview (iframe)。
*   **挑战**：
    *   **点击劫持**：在 iframe 内点击组件时，阻止默认跳转，改为“选中组件”。
    *   **滚动同步**：父子页面滚动条位置同步。
    *   **样式隔离**：确保编辑器 UI 不污染用户页面样式。

### 2. Schema 驱动的动态表单 (Dynamic Props Panel)
*   **难点**：右侧属性面板不是写死的，而是根据 `section.schema.json` 自动生成的。
*   **挑战**：
    *   支持复杂嵌套 (Nested Objects) 和数组 (Repeatable Fields)。
    *   实现**条件渲染** (Conditional Fields)：例如“当 type=image 时显示上传框”。
    *   实现**即时反馈**：输入字符时，画布内组件必须在 <16ms 内更新 (Vue Reactivity)。

### 3. 拖拽与排序 (Drag & Drop)
*   **难点**：在 iframe 内部实现平滑的组件拖拽。
*   **挑战**：
    *   计算拖拽占位符 (Ghost Element) 的准确位置。
    *   处理嵌套组件 (Container内的Block) 的拖拽。
    *   保持 DOM 更新与 JSON Tree 更新的原子性同步。

---

## C. 电商业务重难点 (Commerce Logic)

### 1. 购物车状态机 (Cart State Machine)
*   **难点**：多端同步与状态冲突。
*   **挑战**：
    *   **本地 vs 服务端**：用户未登录时存 LocalStorage，登录后合并到 Shopify 服务端 Cart。
    *   **乐观 UI**：点击加购立即显示成功，API 失败后如何优雅回滚？
    *   **变体匹配**：Shopify 加购需要 Variant ID，前端需处理复杂的 Option 组合逻辑 (Color+Size -> ID)。

### 2. 用户账户体系 (Identity)
*   **难点**：双重身份 (企业 OIDC 账号 vs Shopify Customer)。
*   **挑战**：
    *   Headless 站注册/登录后，如何同步创建 Shopify Customer？
    *   跳转 Checkout 时，如何实现 **Multipass 免登**，避免用户重复登录。

### 3. App 功能复刻 (Third-party Apps)
*   **难点**：Review (Yotpo/Judge.me)、Loyalty (Smile.io) 等 App 的前端 UI 缺失。
*   **挑战**：
    *   **API 调研**：逐个确认 App 是否有 Headless API。
    *   **UI 重写**：在 Nuxt 中完全重写评分星级、评论列表、积分兑换弹窗等组件。

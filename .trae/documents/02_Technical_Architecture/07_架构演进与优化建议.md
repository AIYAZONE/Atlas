# Atlas 架构演进与优化建议

> 本文档旨在为 Atlas 项目的长期维护与持续迭代提供指导，重点关注插件化、可扩展性与运维稳定性。

## 1. 插件化架构深化 (Plugin API)

目前的插件 API 尚处于草案阶段。为了支持未来的“内部插件市场”，需要更具体的实现方案：

### 1.1 插件发现与加载
- **标准配置**：每个插件包必须包含 `atlas-plugin.json`，描述其 `id`, `version`, `capabilities` 和 `entry`。
- **加载机制**：
    - **构建时加载**：通过 Vite 插件扫描 `features/*` 目录，生成插件注册表。
    - **运行时加载**：利用 ESM 的 `import()` 动态加载非核心插件，减少首屏体积。

### 1.2 UI 注入机制 (Slots)
- 在 Builder UI 中预定义 **Slot**（插槽）：
    - `sidebar-top`: 侧边栏顶部（搜索、概览）
    - `editor-toolbar`: 编辑器工具栏（自定义动作）
    - `settings-panel`: 站点/页面设置面板
- 插件通过 `registerUI(slot, component)` 注册自己的 Vue 组件到特定插槽。

### 1.3 沙箱与隔离
- **样式隔离**：插件组件强制使用 CSS Modules 或 Tailwind 前缀，防止污染全局样式。
- **逻辑隔离**：插件通过 `AtlasSDK` 提供的 Hook（如 `usePageData`, `useSiteConfig`）与核心通信，禁止直接操作 DOM 或全局 Store。

---

## 2. 数据模型演进：Schema 迁移引擎

随着业务发展，组件 Schema 必然会发生变更（重命名、删除或结构调整）。

### 2.1 Schema 版本化
- 每个组件定义（Component Definition）必须包含 `version` 字段。
- 数据库存储的页面 JSON 中，每个 Section/Block 记录其创建时的 `schema_version`。

### 2.2 自动迁移流 (Migration Pipeline)
- 在 `packages/schema` 中引入迁移引擎：
    1. **读取**：从 DB 加载页面 JSON。
    2. **对比**：检查数据版本与当前代码库中的 Schema 版本是否一致。
    3. **转换**：如果不一致，顺序执行插件/主题提供的 `transform` 函数。
    4. **校验**：最终产物通过当前版本的 Schema 校验。

---

## 3. 多租户与多品牌隔离

Atlas 未来可能服务于 Jackery 之外的其他子品牌或独立业务单元。

### 3.1 资源隔离
- **S3 Bucket 策略**：按 `brand_id` 或 `site_id` 划分 S3 路径前缀，配置不同的 CDN 加速域名。
- **数据库 RLS**：利用 PostgreSQL 的 Row Level Security (RLS)，确保 API 只能访问所属 `site_id` 的数据。

### 3.2 区域化配置 (Regional Overrides)
- 在 `Site` 层面支持多级配置覆盖：
    - `Global Config` (所有站点共享)
    - `Brand Config` (特定品牌共享)
    - `Site Instance Config` (站点独有，如 `currency`, `language_default`)

---

## 4. 通用数据桥接层 (Universal Data Bridge)

为了集成 ERP、CRM 等外部系统，需建立标准化的数据接入层。

### 4.1 适配器模式 (Adapter Pattern)
- **定义标准接口**：定义 `ICommerceAdapter`, `ICustomerAdapter`, `IInventoryAdapter`。
- **具体实现**：为 Shopify, SAP (ERP), Salesforce (CRM) 分别编写 Adapter。
- **按站点注入**：在站点配置中声明使用的适配器 ID，Java 后端根据配置动态实例化。

### 4.2 数据同步与聚合 (Aggregation)
- **BFF (Backend For Frontend)**：Java 层作为 BFF，聚合来自不同系统的数据（如：从 Shopify 获取商品基本信息，从 ERP 获取实时库存，从 CRM 获取用户等级优惠）。
- **异步同步流**：对于非实时数据，通过消息队列（如 RabbitMQ/Kafka）监听外部系统变更并同步至 Atlas 本地缓存。

---

## 5. 性能与构建规模化

当站点数量从 10 个增长到 100+ 时，Monorepo 的构建压力将剧增。

### 4.1 增量构建增强 (Advanced ISR)
- **依赖追踪**：建立“数据-组件-页面”的映射关系图。
- **局部发布**：当只修改了一个翻译键或一个全局配置时，仅重新生成受影响的页面，而不是全站重新构建。

### 4.2 远程缓存 (Remote Caching)
- 启用 Turborepo 的远程缓存（如 Vercel Remote Cache 或自建），让 CI/CD 节点共享构建缓存，大幅缩短 PR 验证时间。

---

## 6. 运维与监控 (Observability)

### 5.1 发布审计增强
- 记录每次发布的 **“指纹” (Fingerprint)**：
    - `Platform Commit Hash`
    - `Theme Version`
    - `Feature Pack Versions`
    - `Data Snapshot Hash`
- 确保任何时刻的线上产物都能追溯到完整的代码和数据状态。

### 5.2 核心链路监控
- **SLI (Service Level Indicators)**：
    - 编辑器预览延迟 (< 500ms)
    - 单页发布时长 (< 5s)
    - 静态资源 404 比例

# 媒体处理与 CDN 策略规范

## 存储与命名
- S3 Bucket：atlas-media-{env}-{org}
- Key 结构：{org_id}/{asset_id}/{filename}.{ext}
- 变体：{org_id}/{asset_id}/variants/{w}x{h}/{basename}.{format}
- 元数据：尺寸、格式、内容哈希、颜色/EXIF、引用计数、上传者、创建时间

## 上传与派生流程
- 上传直传 S3（STS 临时凭证）或经边缘函数
- 队列任务生成变体：thumb、web、retina；格式优先 webp/avif，保留原始
- 失败重试与幂等：依据内容哈希与 asset_id 去重

## 引用与断联检测
- 引用计数：渲染时或保存时写入 media_ref 表（content_id、field、variant）
- 断联扫描：定期校验引用存在性，提示清理或替换

## CDN 缓存与访问
- 缓存策略：变体资源长缓存（1y）、HTML 短 TTL；内容哈希驱动不可变缓存
- 访问控制：私有资源签名 URL，带过期与 IP/路径约束
- 区域分发：按用户地域选择最近 POP

## 安全与合规
- 病毒扫描与类型白名单；大小上限与速率限制
- 敏感媒体标记与访问审计；GDPR/CCPA 请求处理

## 失效与刷新
- 构建发布后仅刷新 HTML 与清单；媒体静态资源不刷新
- 变体更新（重新派生）采用新哈希与新 Key，避免强刷

## 成本与治理
- 按变体与访问频率分层存储（S3 存储级别）
- 周期性统计资产未引用与大体积资产，生成治理报告

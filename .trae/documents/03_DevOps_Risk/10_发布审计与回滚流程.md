# 发布审计与回滚流程

## 版本与清单

* 构建生成版本号（content/schema 哈希 + 时间戳）

* 产物清单：files\[]、checksums、routes、locale、build\_meta

* 清单写入版本库与数据库版本表

## 发布流程

* 触发构建：CI 或 Builder 内发布操作

* 上传产物：dist → S3（版本化前缀 /releases/{version}）

* 刷新：CloudFront Invalidate 指向路由清单（HTML），静态资源走内容哈希不刷新

* 审计记录：actor\_id、org\_id、version、routes\_count、duration、status

## 审核与审批

* 草稿→审核→发布→失效；发布与回滚需审批人确认

* 审批工作流表：request\_id、type、state、requester\_id、approver\_id、comment

## 回滚流程

* 选择目标版本：读取版本清单

* 切换别名：将 /current 指向 /releases/{version}（或更新路由映射）

* 刷新 HTML 路由，记录回滚审计

## 失败与重试

* 构建失败：停止发布，记录错误与快照；可重试

* 上传失败：断点续传与校验；失败计数与告警

* 刷新失败：重试并降级（缓存自然过期）

## 权限与安全

* 发布/回滚权限：Publisher/Admin

* 双人复核：重大版本或删除操作需双人审批

* 秘钥管理：CI/CD 仅持有最小权限的 S3/CloudFront 令牌

## 可观测性与报告

* 指标：构建耗时、上传速率、刷新条目、失败率

* 报告：每次发布生成概要并发送通知（邮件/IM）


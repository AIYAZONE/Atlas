# 核心风险与应对策略 (Risk Register)

> **文档说明**：本文档汇总了 Headless Shopify (Vue 3 + Nuxt 3) 架构下的核心风险点及其技术应对方案，旨在开发前规避“深坑”。

## 1. 业务流程风险 (Business Flow)

| 风险点 | 影响描述 | 技术应对 / 解决方案 |
| :--- | :--- | :--- |
| **Checkout 域名割裂** | 用户从 `brand.com` 跳转到 `checkout.shopify.com`，信任感下降，且可能被浏览器拦截第三方 Cookie。 | **Shopify Plus**：绑定自定义域名 `checkout.brand.com`。<br>**UI 引导**：在跳转前增加 Loading 页提示“正在前往安全支付环境”。 |
| **GA4/CAPI 归因断裂** | 跳转 Checkout 后 Session ID 变更，导致 GA4 丢失流量来源，无法统计广告转化 ROI。 | **Linker 参数**：在跳转 URL 追加 `?_gl=...` (Google Linker)。<br>**服务端埋点**：Order Webhook -> Supabase -> Meta CAPI/GA4 MP (确保支付成功事件不丢失)。 |
| **用户账户状态同步** | Headless 站登录 (Supabase) 与 Shopify 登录不互通。用户在 Headless 站无法看到 Shopify 历史订单。 | **Multipass 登录**：使用 Shopify Plus Multipass 功能，Headless 登录后生成 Token，跳转 Checkout 时自动免登。 |
| **礼品卡与折扣码** | Shopify 原生支持 URL 自动应用折扣码，Headless 站需手动处理。 | **中间件拦截**：Nuxt Middleware 捕获 URL 参数 `?discount=CODE`，存入 Pinia/Cookie，创建 Checkout 时透传。 |

## 2. 数据与技术风险 (Data & Tech)

| 风险点 | 影响描述 | 技术应对 / 解决方案 |
| :--- | :--- | :--- |
| **SSG 数据滞后** | 静态构建的价格/库存是构建时的快照。构建后改价或卖空，用户看到旧数据，下单报错。 | **Hydration 策略**：静态骨架 + 客户端水合。页面加载 (`onMounted`) 后立即请求最新价格/库存并平滑更新 DOM。 |
| **API 速率限制 (429)** | 全量构建 (SSG) 时，几千个 SKU 并发请求 Shopify API 会触发限流，导致构建失败。 | **构建队列**：实现并发控制 (Concurrency Limit = 5) + 指数退避重试 (Exponential Backoff)。<br>**缓存层**：在 Supabase 层缓存热点数据。 |
| **预览与发布不一致** | 预览用 Edge 实时渲染，发布用 SSG。常见 `window is not defined` 或时区错误。 | **同构渲染**：确保 Preview 和 Build 使用同一套组件代码，仅数据源不同 (Draft JSON vs Published JSON)。 |
| **购物车持久化丢失** | 刷新页面或跨设备时购物车清空，导致转化率下降。 | **LocalStorage**：持久化存储 `cartId`。<br>**Rehydrate**：Pinia 初始化时用 `cartId` 从 Shopify 拉取最新行项目。 |

## 3. 生态与运营风险 (Ecosystem & Ops)

| 风险点 | 影响描述 | 技术应对 / 解决方案 |
| :--- | :--- | :--- |
| **Shopify App 失效** | **(高危)** 依赖 Liquid 注入 UI 的 App (评论/积分/倒计时) 在 Headless 站完全失效。 | **API 重构**：选型 App 时必须确认提供 Storefront API。然后在 Nuxt 中**重写前端 UI** (预留额外开发工时)。 |
| **SEO 权重分散** | Shopify 原生站 (`my.myshopify.com`) 依然可访问，Google 同时收录导致互搏。 | **Canonical**：Headless 页头添加 `<link rel="canonical">`。<br>**Noindex**：修改 Shopify 原生主题代码，注入 `<meta name="robots" content="noindex">`。 |
| **运营所见即所得缺失** | 运营修改文案后需等待 5-10 分钟构建才能看到效果。 | **Visual Builder**：必须提供毫秒级反馈的编辑器。<br>**ISR**：实现增量静态再生成，缩短发布等待时间。 |
| **URL 重定向失效** | Shopify 后台配置的 301 重定向在 Headless 站不生效。 | **Edge Redirects**：定期同步 Shopify 重定向规则到 Vercel/Supabase Edge Config，在 CDN 层拦截跳转。 |
